/**
 * Module: UI Control (v1.0)
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’æä¾›ã—ã¾ã™ã€‚
 */

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒé–‹ã‹ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
function onOpen() {
    const ui = SpreadsheetApp.getUi();
    ui.createMenu('GemSyS Controller')
        .addItem('ğŸ”„ å³æ™‚æ›´æ–° (OneShot)', 'manual_RunOneShot')
        .addItem('ğŸ¤– AIåˆ†æã‚’å®Ÿè¡Œ', 'manual_RunAI')
        .addSeparator()
        .addItem('ğŸ“… æœŸé–“æŒ‡å®šãƒ‡ãƒ¼ã‚¿å–å¾— (CAMS)', 'ui_PromptRangeFetch')
        .addSeparator()
        .addItem('ğŸ§¹ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹/ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Ÿè¡Œ', 'manual_RunMaintenance')
        .addToUi();
}

// ------------------------------------------
// UIã‹ã‚‰ã®å‘¼ã³å‡ºã—ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
// ------------------------------------------

function manual_RunOneShot() {
    const ui = SpreadsheetApp.getUi();
    const result = ui.alert('ç¢ºèª', 'ç¾åœ¨ã®ç’°å¢ƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ', ui.ButtonSet.YES_NO);
    if (result == ui.Button.YES) {
        // ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ›´æ–°é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        main_AirQualityUpdate("MANUAL");
        ui.alert('å®Œäº†', 'æ›´æ–°å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
    }
}

function manual_RunAI() {
    run_AI_Analysis();
}

function manual_RunMaintenance() {
    RunDailyMaintenance();
    SpreadsheetApp.getUi().alert('ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Œäº†', 'å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¨ãƒ­ã‚°æ•´ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * æœŸé–“æŒ‡å®šå–å¾—ã®ãŸã‚ã®UIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 */
function ui_PromptRangeFetch() {
    const ui = SpreadsheetApp.getUi();
    
    // é–‹å§‹æ—¥ã®å…¥åŠ›
    const startResp = ui.prompt(
        'æœŸé–“æŒ‡å®šãƒ‡ãƒ¼ã‚¿å–å¾— (CAMS)',
        'é–‹å§‹æ—¥ã‚’ã€ŒYYYY-MM-DDã€å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(ä¾‹: 2025-12-01)',
        ui.ButtonSet.OK_CANCEL
    );
    if (startResp.getSelectedButton() != ui.Button.OK) return;
    const startDate = startResp.getResponseText().trim();

    // çµ‚äº†æ—¥ã®å…¥åŠ›
    const endResp = ui.prompt(
        'æœŸé–“æŒ‡å®šãƒ‡ãƒ¼ã‚¿å–å¾— (CAMS)',
        'çµ‚äº†æ—¥ã‚’ã€ŒYYYY-MM-DDã€å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(ä¾‹: 2026-01-31)',
        ui.ButtonSet.OK_CANCEL
    );
    if (endResp.getSelectedButton() != ui.Button.OK) return;
    const endDate = endResp.getResponseText().trim();

    // æ—¥ä»˜å½¢å¼ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
    const datePattern = /^\d{4}-\d{2}-\d{2}$/;
    if (!datePattern.test(startDate) || !datePattern.test(endDate)) {
        ui.alert('ã‚¨ãƒ©ãƒ¼', 'æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã€ŒYYYY-MM-DDã€ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
        return;
    }

    // ç¢ºèª
    const confirm = ui.alert(
        'å®Ÿè¡Œç¢ºèª', 
        `ä»¥ä¸‹ã®æœŸé–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€CAMSã‚·ãƒ¼ãƒˆã‚’å†æ§‹ç¯‰ï¼ˆã¾ãŸã¯è¿½è¨˜ï¼‰ã—ã¾ã™ã€‚\n\næœŸé–“: ${startDate} ï½ ${endDate}\n\nâ€»æ³¨æ„: ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`,
        ui.ButtonSet.YES_NO
    );

    if (confirm == ui.Button.YES) {
        try {
            // ä¸‹è¨˜ã®æœŸé–“æŒ‡å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—
            run_Range_CAMS_Fetch(startDate, endDate);
            ui.alert('å®Œäº†', 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
        } catch (e) {
            console.error(e);
            ui.alert('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', `å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n${e.message}`, ui.ButtonSet.OK);
        }
    }
}